<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartBus â€” Verifier</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  
  <style>
    :root { --primary: #1f2a56; --accent: #ffc107; --success: #22b573; --error: #ff4d4d; }
    body { margin: 0; font-family: 'Inter', sans-serif; background: #f0f4f8; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    .container { width: 95%; max-width: 450px; background: white; border-radius: 24px; padding: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; }
    #reader { width: 100%; border-radius: 16px; overflow: hidden; border: 4px solid var(--primary); }
    .status-card { margin-top: 25px; padding: 20px; border-radius: 16px; display: none; text-align: left; animation: slideUp 0.3s ease; }
    .valid { background: #eafaf1; border: 2px solid var(--success); display: block; }
    .invalid { background: #fdeeee; border: 2px solid var(--error); display: block; }
    .btn-reset { margin-top: 20px; width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div class="container">
    <h2 style="color: var(--primary);"><i class='bx bx-shield-quarter'></i> Pass Verifier</h2>
    <div id="reader"></div>
    
    <div id="resultCard" class="status-card">
      <div id="statusHeader" style="font-weight: 800; font-size: 1.2rem; margin-bottom: 10px;"></div>
      <div id="passDetails" style="font-size: 0.9rem; line-height: 1.6;"></div>
      <button class="btn-reset" onclick="location.reload()">Scan Next Passenger</button>
    </div>
    
    <p id="hint" style="color: #666; margin-top: 15px;">Awaiting Passenger QR Code...</p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBNuza4ltSYYZf5eml5jdrjh_FuI8Rappk",
      authDomain: "smart-bus-pass-system-b3950.firebaseapp.com",
      projectId: "smart-bus-pass-system-b3950",
      storageBucket: "smart-bus-pass-system-b3950.firebasestorage.app",
      messagingSenderId: "422432816761",
      appId: "1:422432816761:web:eb86fe0ee38153833ddea8",
      measurementId: "G-H2M8MTJE4Q"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function verifyPass(qrValue) {
      const card = document.getElementById("resultCard");
      const header = document.getElementById("statusHeader");
      const details = document.getElementById("passDetails");
      
      try {
        // Expected format: PASS_userID_passID (as defined in buyPass.js)
        const parts = qrValue.split('_');
        if (parts.length < 3) throw new Error("Invalid QR Format");

        const userID = parts[1];
        const passID = parts[2];

        const passDoc = await db.collection("users").doc(userID).collection("passes").doc(passID).get();
        const userDoc = await db.collection("users").doc(userID).get();

        if (passDoc.exists && userDoc.exists) {
          const pass = passDoc.data();
          const user = userDoc.data();
          const expiry = pass.endDate.toDate();
          const isValid = expiry > new Date();

          card.className = isValid ? "status-card valid" : "status-card invalid";
          header.innerHTML = isValid ? "<i class='bx bxs-check-circle'></i> PASS VALID" : "<i class='bx bxs-x-circle'></i> PASS EXPIRED";
          header.style.color = isValid ? "var(--success)" : "var(--error)";
          
          details.innerHTML = `
            <b>Passenger:</b> ${user.username}<br>
            <b>Plan:</b> ${pass.plan}<br>
            <b>Expires:</b> ${expiry.toLocaleString()}<br>
            <b>Payment ID:</b> ${pass.paymentId}
          `;
        } else {
          throw new Error("Pass not found in database");
        }
      } catch (err) {
        card.className = "status-card invalid";
        header.innerHTML = "VERIFICATION FAILED";
        details.innerHTML = err.message;
      }
      document.getElementById("hint").style.display = "none";
    }

    const scanner = new Html5Qrcode("reader");
    scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
      scanner.stop();
      verifyPass(text);
    });
  </script>
</body>
</html>